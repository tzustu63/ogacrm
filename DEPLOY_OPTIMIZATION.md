# 部署優化說明

## 概述

為了加快後續部署速度，我們已經優化了部署流程。現在有三種部署方式可選：

## 部署腳本說明

### 1. `deploy-prod.sh` - 標準部署（已優化）
**適用場景**：首次部署或需要完整重建時

**優化內容**：
- ✅ 啟用 Docker BuildKit（加快構建速度）
- ✅ 使用 Docker 層緩存（不再使用 --no-cache）
- ✅ npm 依賴使用緩存掛載

**使用方式**：
```bash
./deploy-prod.sh
```

**預期時間**：
- 首次部署：5-8 分鐘
- 後續部署：2-4 分鐘（使用緩存）

---

### 2. `deploy-fast.sh` - 快速部署 ⚡
**適用場景**：頻繁更新程式碼，需要快速查看結果

**特點**：
- ⚡ 使用所有緩存加速
- ⚡ 簡化的檢查流程
- ⚡ 適合開發測試階段

**使用方式**：
```bash
./deploy-fast.sh
```

**預期時間**：
- 僅代碼變更：1-3 分鐘
- 依賴變更：2-4 分鐘

---

### 3. `deploy-smart.sh` - 智能部署 🧠
**適用場景**：只想更新改變的部分，最大化速度

**特點**：
- 🧠 自動檢測代碼變更
- 🧠 只構建改變的服務（前端或後端）
- 🧠 如果沒有變更，只重啟服務

**使用方式**：
```bash
./deploy-smart.sh
```

**預期時間**：
- 無變更：10-20 秒（只重啟）
- 僅前端變更：1-2 分鐘
- 僅後端變更：1-2 分鐘
- 兩者都變更：2-3 分鐘

---

## 優化技術細節

### 1. Docker BuildKit
啟用了 Docker BuildKit，可以：
- 並行構建多個階段
- 更好的緩存管理
- 更快的構建速度

### 2. npm 緩存掛載
在 Dockerfile 中使用 `--mount=type=cache,target=/root/.npm`：
- npm 依賴包會被緩存
- 後續構建時直接使用緩存
- 減少下載時間 30-50%

### 3. Docker 層緩存
- 移除了 `--no-cache` 標誌
- Docker 會重用未改變的層
- 只有改變的部分才會重新構建

---

## 使用建議

### 開發階段（頻繁更新）
```bash
# 推薦使用快速部署
./deploy-fast.sh
```

### 生產環境更新
```bash
# 如果確定只改了前端或後端
./deploy-smart.sh

# 如果不確定，使用標準部署
./deploy-prod.sh
```

### 首次部署或重大更新
```bash
# 使用標準部署腳本
./deploy-prod.sh
```

---

## 性能對比

| 場景 | 優化前 | 優化後 | 提升 |
|------|--------|--------|------|
| 首次部署 | 5-8 分鐘 | 5-8 分鐘 | - |
| 僅代碼變更 | 5-8 分鐘 | 1-3 分鐘 | **60-70%** |
| 僅前端變更 | 5-8 分鐘 | 1-2 分鐘 | **70-80%** |
| 僅後端變更 | 5-8 分鐘 | 1-2 分鐘 | **70-80%** |
| 無變更（重啟） | 5-8 分鐘 | 10-20 秒 | **95%+** |

---

## 注意事項

1. **首次部署**：第一次使用時，緩存尚未建立，速度與之前相同
2. **緩存清理**：如果需要完全重建，可以使用：
   ```bash
   docker-compose -f docker-compose.prod.yml build --no-cache
   ```
3. **Git 狀態**：智能部署需要 Git 歷史記錄，確保在 Git 倉庫中運行

---

## 故障排除

### 如果快速部署失敗
```bash
# 回退到標準部署
./deploy-prod.sh
```

### 如果緩存出現問題
```bash
# 清理 Docker 緩存
docker system prune -a

# 然後使用標準部署
./deploy-prod.sh
```

### 查看構建日誌
```bash
docker-compose -f docker-compose.prod.yml build --progress=plain
```

